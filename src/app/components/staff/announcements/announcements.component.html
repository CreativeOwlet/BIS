<div class="max-w-4xl mx-auto p-6">
  <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-4">
    <div class="flex gap-2 w-full sm:w-auto">
      <button pButton pRipple type="button" icon="pi pi-arrow-left" (click)="goBack()" class="p-button-text p-button-sm" aria-label="Back"></button>
      <h2 class="text-xl font-semibold flex-1 text-center sm:text-left">Announcements</h2>
    </div>
  <button type="button" (click)="openAddForm()" class="hidden sm:inline-block sm:w-auto px-4 py-2 rounded bg-indigo-600 text-white font-medium hover:bg-indigo-700">+ Post Announcement</button>
  <!-- Sticky Post Announcement button for mobile -->
  <button type="button" (click)="openAddForm()" class="fixed bottom-0 left-0 right-0 z-40 w-full sm:hidden px-4 py-3 bg-indigo-600 text-white font-medium text-lg rounded-none shadow-lg">+ Post Announcement</button>
  </div>

  <div *ngIf="error" class="mb-4 p-3 bg-red-50 text-red-700 rounded">{{ error }}</div>

  <div *ngIf="loading" class="text-center py-10 text-gray-600">Loading announcements...</div>

  <div *ngIf="!loading && announcements.length > 0" class="grid gap-4 mb-6 sm:grid-cols-2" (click)="closeMenu()">
    <div *ngFor="let announcement of announcements" class="p-3 sm:p-4 bg-white rounded shadow flex flex-col sm:flex-row items-start gap-2 sm:gap-3 cursor-pointer hover:shadow-md transition" (click)="selectAnnouncement(announcement)">
      <div class="text-2xl mt-1">{{ getCategoryIcon(announcement.category) }}</div>
      <div class="flex-1 w-full block">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 w-full text-left">
          <div class="flex items-center gap-2 w-full">
            <h3 class="font-medium text-base truncate text-left">{{ announcement.title || 'Untitled' }}</h3>
            <span class="text-xs px-2 py-0.5 rounded-full" [ngClass]="announcement.isActive ? 'bg-emerald-500 text-white' : 'bg-gray-200 text-gray-700'" [attr.aria-label]="announcement.isActive ? 'Active' : 'Inactive'">{{ announcement.isActive ? 'Active' : 'Inactive' }}</span>
            <span class="flex-1"></span>
            <div class="relative self-end sm:self-auto">
              <button
                type="button"
                class="text-sm text-gray-600 opacity-100 focus:opacity-100 transition"
                (click)="openMenu($event, announcement.id)"
                aria-haspopup="true"
                [attr.aria-expanded]="selectedMenuId === announcement.id"
                [attr.aria-controls]="'kebab-menu-' + announcement.id"
                aria-label="Open announcement actions"
              >
                ⋮
              </button>
              <div *ngIf="selectedMenuId === announcement.id" id="kebab-menu-{{announcement.id}}" class="absolute right-0 top-6 bg-white border border-gray-200 shadow-lg rounded z-40 flex flex-col min-w-[120px]" role="menu" aria-label="Announcement actions">
                <button role="menuitem" type="button" class="px-4 py-2 text-left hover:bg-gray-100 text-sm" (click)="$event.stopPropagation(); toggleActive(announcement)">{{ announcement.isActive ? 'Set Inactive' : 'Set Active' }}</button>
                <button role="menuitem" type="button" class="px-4 py-2 text-left hover:bg-gray-100 text-sm text-red-600" (click)="$event.stopPropagation(); deleteAnnouncement(announcement.id)">Delete</button>
              </div>
            </div>
          </div>
        </div>
  <p class="text-sm text-gray-600 mt-1 line-clamp-2">{{ announcement.content || 'No details provided.' }}</p>
        <div class="text-xs text-gray-400 mt-2 flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2">
          <span class="uppercase px-2 py-0.5 bg-gray-100 rounded text-[10px]">{{ announcement.category }}</span>
          <span>{{ announcement.createdAt | date: 'short' }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Announcement details modal -->
  <div *ngIf="selectedAnnouncement" class="fixed inset-0 bg-black/50 flex items-center justify-center p-2 sm:p-4 z-50" (click)="closeAnnouncementDetails()">
    <div class="bg-white rounded-lg w-full max-w-2xl p-4 sm:p-6 relative" role="dialog" aria-modal="true" aria-labelledby="staff-announcement-title" (click)="$event.stopPropagation()">
      <button type="button" class="absolute top-4 right-4 text-gray-500" aria-label="Close announcement details" (click)="closeAnnouncementDetails()">
        ✕
      </button>
      <div class="flex items-center gap-4 mb-4">
        <div class="text-3xl">{{ getCategoryIcon(selectedAnnouncement.category) }}</div>
        <h2 id="staff-announcement-title" class="text-xl font-semibold">{{ selectedAnnouncement.title }}</h2>
      </div>
      <div class="flex items-center gap-3 text-sm text-gray-500 mb-4"><span class="uppercase bg-indigo-600 text-white px-2 py-1 rounded">{{ getCategoryLabel(selectedAnnouncement.category) }}</span><span>{{ selectedAnnouncement.createdAt | date: 'medium' }}</span></div>
      <div class="prose max-w-none">{{ selectedAnnouncement.content }}</div>
      <div *ngIf="selectedAnnouncement.attachmentUrl" class="mt-4 p-3 bg-gray-50 rounded">Attachment: <a [href]="selectedAnnouncement.attachmentUrl" target="_blank" class="text-indigo-600">Download</a></div>
    </div>
  </div>

  <!-- Snackbar for undo -->
  <div *ngIf="snackbarVisible" class="fixed bottom-6 right-6 bg-gray-900 text-white px-4 py-2 rounded flex items-center gap-4 shadow-lg z-50">
    <span>{{ snackbarMessage }}</span>
    <button type="button" class="underline text-sm" (click)="undoDelete()">Undo</button>
  </div>

  <div *ngIf="!loading && announcements.length === 0" class="text-center p-8 bg-white rounded shadow text-gray-500">No announcements yet. Create one to get started!</div>

  <div *ngIf="showAddForm" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" (click)="closeAddForm()">
    <div class="bg-white rounded-lg w-full max-w-md p-6" (click)="$event.stopPropagation()">
      <h3 class="text-lg font-semibold mb-3">Post New Announcement</h3>
      <form (ngSubmit)="addAnnouncement()" class="space-y-4">
        <div>
          <label class="block mb-1 font-medium">Title:</label>
          <input
            type="text"
            [(ngModel)]="newAnnouncement.title"
            name="title"
            placeholder="Announcement title"
            required
            class="w-full rounded border-gray-200 p-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
          />
        </div>
        <div>
          <label class="block mb-1 font-medium">Content:</label>
          <textarea
            [(ngModel)]="newAnnouncement.content"
            name="content"
            placeholder="Write your announcement here..."
            rows="5"
            required
            class="w-full rounded border-gray-200 p-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
          ></textarea>
        </div>
        <div>
          <label class="block mb-1 font-medium">Category:</label>
          <select [(ngModel)]="newAnnouncement.category" name="category" class="w-full rounded border-gray-200 p-2">
            <option value="event">Event</option>
            <option value="alert">Alert</option>
            <option value="update">Update</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <input
            type="checkbox"
            [(ngModel)]="newAnnouncement.isActive"
            name="isActive"
            id="isActive"
            class="accent-indigo-600"
          />
          <label for="isActive" class="font-medium">Post immediately</label>
        </div>
        <div class="flex gap-2 mt-4">
          <button type="submit" class="flex-1 px-4 py-2 rounded bg-indigo-600 text-white font-medium hover:bg-indigo-700">Post Announcement</button>
          <button type="button" (click)="closeAddForm()" class="flex-1 px-4 py-2 rounded bg-gray-200 text-gray-700 font-medium hover:bg-gray-300">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
